<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>


    <title>Document</title>

    <link rel="stylesheet" type="text/css" href="main.css">
    <!-- <link href="bootstrap.css" rel="stylesheet"> -->


    <script src="./node_modules/web3/dist/web3.min.js"></script>

</head>
<body>
    <div class="container">

        

    <div class="container">
        <div class="header">
            
            <h1><img src='logo.png' alt="logo"/>SEA Pharma Blockchain</h1>
          
        </div>
          <div class="container card">
            <h3>All Transactions</h3><br>
            <h4 id="transactionCount"></h4>
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Drug ID</th>
                  <th>Drug Name</th>
                  <th>Quantity</th>
                  <th>Location</th>
                  <th>Transaction Added By</th>
                  <th>Buyer ID</th>
                  <th>Buyer Name</th>
                  <th>Seller ID</th>
                  <th>Seller Name</th>
                </tr>
              </thead >
               <tbody id = "display_table">
            
              </tbody>
            </table>
          </div>

        <div class="container card">
          <h3 >Add Transaction</h3><br><br>
          <form class="form-horizontal" action="javascript:void(0);">
            <div class="form-group">
              <label class="control-label col-sm-2">Drug ID</label>
              <div class="col-sm-10">
                <input type="text" class="form-control" id="drugId" placeholder="Enter Drug ID">
              </div>
            </div>
            <div class="form-group">
              <label class="control-label col-sm-2">Drug Name</label>
              <div class="col-sm-10">          
                <input type="text" class="form-control" id="drugName" placeholder="Enter Drug Name: "">
              </div>
            </div>

            <div class="form-group">
              <label class="control-label col-sm-2">Buyer ID</label>
              <div class="col-sm-10">          
                <input type="text" class="form-control" id="buyerId" placeholder="Enter Buyer ID"">
              </div>
            </div>

            <div class="form-group">
              <label class="control-label col-sm-2">Buyer Name</label>
              <div class="col-sm-10">          
                <input type="text" class="form-control" id="buyerName" placeholder="Enter Buyer Name"">
              </div>
            </div>

            <div class="form-group">
              <label class="control-label col-sm-2">Seller ID</label>
              <div class="col-sm-10">          
                <input type="text" class="form-control" id="sellerId" placeholder="Enter Seller ID"">
              </div>
            </div>
            
            <div class="form-group">
              <label class="control-label col-sm-2">Seller Name</label>
              <div class="col-sm-10">          
                <input type="text" class="form-control" id="sellerName" placeholder="Enter Seller Name"">
              </div>
            </div>

            <div class="form-group">
              <label class="control-label col-sm-2">Quantity</label>
              <div class="col-sm-10">          
                <input type="text" class="form-control" id="quantity" placeholder="Enter Seller Name"">
              </div>
            </div>  

            <div class="form-group">
              <label class="control-label col-sm-2">Location</label>
              <div class="col-sm-10">          
                <input type="text" class="form-control" id="location" placeholder="Enter Seller Name"">
              </div>
            </div>  


            <div class="form-group">        
              <div class="col-sm-offset-2 col-sm-10">
                <button type="submit" class="btn btn-default" id="button">Add Transaction</button>
              </div>
            </div>
          </form>
        </div>



<!--         <h2 id="transaction"></h2>
        <h2 id="transaction_results"></h2>
 -->
        <div class="container card">
          <h3 >Search by Drug ID</h3><br><br>
          <form class="form-horizontal" action="javascript:void(0);">
           
            <div class="form-group">
              <label class="control-label col-sm-2">Search transactions by Drug ID</label>
              <div class="col-sm-10">          
                <input type="text" class="form-control" id="drug_search_id" placeholder="Enter Drug ID">
              </div>
            </div>  

            <div class="form-group">        
              <div class="col-sm-offset-2 col-sm-10">
                <button type="submit" class="btn btn-default" id="drug_search">Search</button>
              </div>
            </div>
          </form>
<!--         </div>
    <div class="container">
 -->          
          <h3 class='drug_search_table_box'>Drug ID specific Transactions</h3>
            <table class="table table-hover drug_search_table_box card">
              <thead>
                <tr>
                  <th>Drug ID</th>
                  <th>Drug Name</th>
                  <th>Quantity</th>
                  <th>Location</th>
                  <th>Transaction Added By</th>
                  <th>Buyer ID</th>
                  <th>Buyer Name</th>
                  <th>Seller ID</th>
                  <th>Seller Name</th>
                </tr>
              </thead >
               <tbody id = "drug_search_results_box">
            
              </tbody>
            </table>
        </div>

        <div class="container card">
          <h3 >Search by Transaction ID</h3><br><br>
          <form class="form-horizontal" action="javascript:void(0);">
           
            <div class="form-group">
              <label class="control-label col-sm-2">Search transactions by Seller ID</label>
              <div class="col-sm-10">          
                <input type="text" class="form-control" id="search_id" placeholder="Enter Transaction ID">
              </div>
            </div>  

            <div class="form-group">        
              <div class="col-sm-offset-2 col-sm-10">
                <button type="submit" class="btn btn-default" id="search">Search</button>
              </div>
            </div>
          </form>
          <h2 class="trans_search_table_box">Seller ID Search</h2>
            <table class="table table-hover trans_search_table_box card">
              <thead>
                <tr>
                  <th>Drug ID</th>
                  <th>Drug Name</th>
                  <th>Quantity</th>
                  <th>Location</th>
                  <th>Transaction Added By</th>
                  <th>Buyer ID</th>
                  <th>Buyer Name</th>
                  <th>Seller ID</th>
                  <th>Seller Name</th>
                </tr>
              </thead >
               <tbody id = "search_results_box">
            
              </tbody>
            </table>
        </div>

<!--         <h3 id="drug_search_results_box"></h3>
 -->        


        <!-- <label for="search_id" class="col-lg-2 control-label">Search transaction by ID</label>
        <input id="search_id" type="text">

        <button id="search">Search by ID</button>

        <h3 id="search_results_box"></h3>

        <label for="drug_search_id" class="col-lg-2 control-label">Search transaction by Drug ID</label>
        <input id="drug_search_id" type="text">

        <button id="drug_search">Search by ID</button>

        <h3 id="drug_search_results_box"></h3> -->

        

    </div>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>

    <script>

        if (typeof web3 !== 'undefined') {
            web3 = new Web3(web3.currentProvider);
        } else {
            // set the provider you want from Web3.providers
            web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
        }

        web3.eth.defaultAccount = web3.eth.accounts[0];


        var SeaPharmaContract = web3.eth.contract(

[
    {
        "constant": true,
        "inputs": [
            {
                "name": "_id",
                "type": "uint256"
            }
        ],
        "name": "getBuyerSellerDetails",
        "outputs": [
            {
                "name": "",
                "type": "uint256"
            },
            {
                "name": "",
                "type": "string"
            },
            {
                "name": "",
                "type": "uint256"
            },
            {
                "name": "",
                "type": "string"
            },
            {
                "name": "",
                "type": "uint256"
            },
            {
                "name": "",
                "type": "string"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [
            {
                "name": "_id",
                "type": "uint256"
            }
        ],
        "name": "getTransactionDetails",
        "outputs": [
            {
                "name": "",
                "type": "uint256"
            },
            {
                "name": "",
                "type": "string"
            },
            {
                "name": "",
                "type": "uint256"
            },
            {
                "name": "",
                "type": "string"
            },
            {
                "name": "",
                "type": "address"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [],
        "name": "getAllTransactions",
        "outputs": [
            {
                "name": "",
                "type": "uint256[]"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [
            {
                "name": "",
                "type": "uint256"
            }
        ],
        "name": "transactionsArr",
        "outputs": [
            {
                "name": "",
                "type": "uint256"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [],
        "name": "getTransactionId",
        "outputs": [
            {
                "name": "",
                "type": "uint256"
            }
        ],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [],
        "name": "transactionId",
        "outputs": [
            {
                "name": "",
                "type": "uint256"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "constant": false,
        "inputs": [
            {
                "name": "_drugId",
                "type": "uint256"
            },
            {
                "name": "_drugName",
                "type": "string"
            },
            {
                "name": "_buyerId",
                "type": "uint256"
            },
            {
                "name": "_buyerName",
                "type": "string"
            },
            {
                "name": "_sellerId",
                "type": "uint256"
            },
            {
                "name": "_sellerName",
                "type": "string"
            },
            {
                "name": "_quantity",
                "type": "uint256"
            },
            {
                "name": "_location",
                "type": "string"
            },
            {
                "name": "_address",
                "type": "address"
            }
        ],
        "name": "setDrugTransaction",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "constant": true,
        "inputs": [],
        "name": "countTransactions",
        "outputs": [
            {
                "name": "",
                "type": "uint256"
            }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": false,
                "name": "id",
                "type": "uint256"
            },
            {
                "indexed": false,
                "name": "drugId",
                "type": "uint256"
            },
            {
                "indexed": false,
                "name": "drugName",
                "type": "string"
            },
            {
                "indexed": false,
                "name": "buyerId",
                "type": "uint256"
            },
            {
                "indexed": false,
                "name": "buyerName",
                "type": "string"
            },
            {
                "indexed": false,
                "name": "sellerId",
                "type": "uint256"
            },
            {
                "indexed": false,
                "name": "sellerName",
                "type": "string"
            },
            {
                "indexed": false,
                "name": "quantity",
                "type": "uint256"
            },
            {
                "indexed": false,
                "name": "location_",
                "type": "string"
            },
            {
                "indexed": false,
                "name": "transactionAddedBy",
                "type": "address"
            }
        ],
        "name": "transactionInfo",
        "type": "event"
    }
]

);

    var SeaPharma = SeaPharmaContract.at('0x7ca7122d2b74b0aa6af92151b700c0ab9b455e21');
    console.log(SeaPharma);
 // var balance = web3.eth.getBalance('0x101de57c4e8c1761d7cf5d25600a2779bc68c4e6');
 // console.log(balance);
// ----------------------------transaction event -----------------------------------

       var transactionInfoEvent = SeaPharma.transactionInfo({}, 'latest');

       transactionInfoEvent.watch(function(error, result){
            $("#transaction_results").html('Results: ' + result.args.drugId + '. ' + result.args.drugName + '. ' + result.args.buyerId + '. ' + result.args.buyerName + '. ' + result.args.sellerId + '. ' + result.args.sellerName + '. ' + result.args.quantity + '. ' + result.args.location_ + '. ' + result.args.transactionAddedBy + '. ' );

       });

        var numOfTransactions;

       
       
        SeaPharma.countTransactions((err, res) => {
            if(res){
                $("#transactionCount").html(res.c + ' Transactions');
                numOfTransactions = res.c;
             }
        });


// ----------------------------get all transactions -----------------------------------


        var allTransactionsList = [];


        SeaPharma.getAllTransactions((err, alltrans_result) => {


            if(alltrans_result){

                var i;
                var table_display_str = '';
                var bId, bName, sId, sName;
                for(i=0; i<alltrans_result.length; i++){
                    var t = alltrans_result[i].c;
                    var tmpList=[];
                    SeaPharma.getBuyerSellerDetails(t, (err, bs_res) => {


                        // console.log(bs_res);

                    
                        bId = bs_res[2].c;
                        bName =bs_res[3];
                        sId = bs_res[4].c;
                        sName = bs_res[5];

                        // tmpList = [bId, bName, sId, sName];

                        // console.log(bId, bName, sId, sName);


                        });

                        SeaPharma.getTransactionDetails(t, (err, search_res) => {
                            if(search_res){


                                tmpList = [search_res[0].c, search_res[1], search_res[2].c, search_res[3], search_res[4], bId, bName, sId, sName];
                                allTransactionsList.push(tmpList);


                                table_display_str = table_display_str + "<tr><td>" + tmpList[0]+ "</td><td>"+ tmpList[1] +"</td><td>"+ tmpList[2] +"</td><td>"+ tmpList[3] +"</td><td>"+ tmpList[4] +"</td><td>" + tmpList[5] +"</td><td>"+ tmpList[6] +"</td><td>"+ tmpList[7] +"</td><td>"+ tmpList[8] +"</td></tr>";
                                $("#display_table").html(table_display_str);
                                console.log(tmpList);

                            }

                        });

                    


                }
            }
        });

        console.log(allTransactionsList);

// ----------------------------drug search method------------------

        var t = $("#drug_search").click(function() {
                        $(".drug_search_table_box").show();

         var drugDisplayList = [];

            var i;
            for(i=0; i<allTransactionsList.length; i++)
            {

                var _dID = $("#drug_search_id").val();

                if(_dID == allTransactionsList[i][0]){
                    drugDisplayList.push(allTransactionsList[i]);
                }


            }

        var drug_table_disp_str = '';

            for(i=0; i< drugDisplayList.length; i++)
            {

                drug_table_disp_str = drug_table_disp_str + "<tr><td>" + drugDisplayList[i][0]+ "</td><td>"+ drugDisplayList[i][1] +"</td><td>"+ drugDisplayList[i][2] +"</td><td>"+ drugDisplayList[i][3] +"</td><td>"+ drugDisplayList[i][4] +"</td><td>"+ drugDisplayList[i][5] +"</td><td>"+ + drugDisplayList[i][6] +"</td><td>"+ + drugDisplayList[i][7] +"</td><td>"+ drugDisplayList[i][8] +"</td></tr>";
                            $("#drug_search_results_box").html(drug_table_disp_str);
            }
            
        });
// ------------------------------add transaction method -----------

        var t = $("#button").click(function() {

            SeaPharma.setDrugTransaction($("#drugId").val(), $("#drugName").val(), $("#buyerId").val(), $("#buyerName").val(), $("#sellerId").val(), $("#sellerName").val(), $("#quantity").val(), $("#location").val(), web3.eth.defaultAccount, (err, res) => {

                if(err){
                    $("#transaction").html(err + '!!');
                    console.log(err);
                }

            });

        });
// ------------------------------------------transaction id search --------------

        var s = $("#search").click(function(){//button name search
                        $(".trans_search_table_box").show();

            var transaction_search_str = '';          

            var i;
            for(i=0; i<allTransactionsList.length; i++)
            {

                var _tID = $("#search_id").val();

                if(_tID == allTransactionsList[i][0]){

                    transaction_search_str = "<tr><td></td><td>" + allTransactionsList[i][0]+ "</td><td>"+ allTransactionsList[i][1] +"</td><td>"+ allTransactionsList[i][2] +"</td><td>"+ allTransactionsList[i][3] +"</td><td>"+ allTransactionsList[i][4] +"</td><td>"+ allTransactionsList[i][5] +"</td><td>"+ + allTransactionsList[i][6] +"</td><td>"+ + allTransactionsList[i][7] +"</td><td>"+ allTransactionsList[i][8] +"</td></tr>";


                }
                $("#search_results_box").html(transaction_search_str);
                console.log(transaction_search_str);


            }

        });

    </script>

        <!-- Bootstrap core JavaScript -->
<!--     <script src="jquery.js"></script>
    <script src="bootstrap.bundle.js"></script>
 -->

</body>
</html>

